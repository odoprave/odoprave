<!DOCTYPE html>
<html lang="sk"><head>
    <title>Alternatívne odoprave</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link href="https://odoprave.github.io/odoprave/" rel="canonical" />
    <link href="css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="css/ol.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="css/ol3-sidebar.css" type="text/css" />
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <style>
        body {
            padding: 0;
            margin: 0;
            overflow: hidden;
        }
        html, body, #map {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }
    </style>
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
</head>
<body>
    <noscript><div class="warning">Upozornenie: Váš prehliadač nepodporuje javascript, ktorý je pre plnú funkčnosť potrebný.</div></noscript>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab" title="Mapy a vrstvy"><i class="fa fa-map"></i></a></li>
                <li><a href="#direction" role="tab" title="Trasa"><i class="fa fa-compass"></i></a></li>
                <li><a href="#transport" role="tab" title="Cestovné poriadky"><i class="fa fa-bus"></i></a></li>
                <li><a href="#feedback" role="tab" title="Spätná väzba"><i class="fa fa-comment"></i></a></li>
                <li><a href="#monitoring" role="tab" title="Monitovanie"><i class="fa fa-tachometer"></i></a></li>
                <li><a href="#settings" role="tab" title="Nastavenia"><i class="fa fa-gear"></i></a></li>
                <li><a href="#info" role="tab" title="O projekte"><i class="fa fa-info"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">Mapy a vrstvy<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p id="switcher" class="layer-switcher"></p>
            </div>

            <div class="sidebar-pane" id="direction">
                <h1 class="sidebar-header">Trasa<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p>Čakáme na dobrovoľníka, ktorý implementuje túto funkcionalitu.
                Zatiaľ odporúčame použiť <a href="https://www.google.sk/maps?source=tldsi&hl=sk" target="_blank">Google maps</a>.</p>
            </div>

            <div class="sidebar-pane" id="transport">
                <h1 class="sidebar-header">Cestovné poriadky<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p>Čakáme na dobrovoľníka, ktorý implementuje túto funkcionalitu.
                Zatiaľ odporúčame použiť <a href="http://cp.atlas.sk/vlakbus/spojenie/" target="_blank">Cp.sk</a>.</p>
            </div>

            <div class="sidebar-pane" id="feedback">
                <h1 class="sidebar-header">Spätná väzba<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p>
                <b>Jedným klikom</b> nám prosím poskytnite Váš názor na alternatívne odoprave:<br />
                <i class="fa fa-thumbs-up" style="color: green; font-size: 200%;"></i>&nbsp;
                <i class="fa fa-thumbs-down" style="color: red; font-size: 200%;"></i>
                </p>
                <p>
                Taktiež nám môžete <a href="https://docs.google.com/forms/d/e/1FAIpQLSeD26FnP02xbYaLDdVvbyOiqe2Ry-89knGcvqq2Z3nUlrUJeQ/viewform" target="_blank">napísať Vaše podnety cez formulár</a>.
                </p>
            </div>

            <div class="sidebar-pane" id="monitoring">
                <h1 class="sidebar-header">Monitorovanie<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>

            <div class="sidebar-pane" id="settings">
                <h1 class="sidebar-header">Nastavenia<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p>
                <b>1. Cookies</b><br />Cookies sú použité napríklad na zapamätanie poslednej pozície na mape.
                V prípade problémov ich môžete vymazať.<br />
                <a href="#" onclick="clearCookies(); return false;">Vymazať cookies</a>
                </p>
            </div>

            <div class="sidebar-pane" id="info">
                <h1 class="sidebar-header">O projekte<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                <p>
                Aký sa snaží byť výskumný projekt Alternatívne odoprave?
                <ul>
                  <li>prívetivý pre používateľov</li>
                  <li>nenáročný na prevádzkové náklady</li>
                  <li>otvorený komunitnému vývoju</li>
                  <li>nekomerčný</li>
                </ul>
                </p>
                <p>Chceš sa zapojiť a vylepšiť funkcionalitu?<p>
                Navštív <a href="https://github.com/odoprave/odoprave" target="_blank">github.com/odoprave/odoprave</a>
            </div>
        </div>
    </div>

    <div id="map" class="sidebar-map"></div>

    <script src="js/ol.js" type="text/javascript"></script>
    <script src="js/ol3-sidebar.min.js"></script>
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="js/ol3-layerswitcher.js"></script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-90652142-2', 'auto');
    ga('send', 'pageview');

    // layers   - https://odoprave.info/gis/configuration/layer
    // features - https://odoprave.info/geoserver/nsdi/wms?REQUEST=GetFeatureInfo&EXCEPTIONS=application/json&BBOX=2035059.4410645328,6261721.357121639,2191602.4749925737,6418264.39104968&SERVICE=WMS&INFO_FORMAT=application/json&QUERY_LAYERS=nsdi:traffic_event,nsdi:uds&FEATURE_COUNT=50&TRANSPARENT=true&Layers=nsdi:traffic_event,nsdi:uds&WIDTH=256&HEIGHT=256&format=image/png&CQL_FILTER=(traffic_event_status='active') or (traffic_event_status='definedByValidityTimeSpec' AND ((valid_to >= '2017-01-27T23:45:12+0000' and valid_from <= '2017-01-27T23:45:12+0000') OR (valid_to IS NULL and valid_from <= '2017-01-27T23:45:12+0000'))) OR (traffic_event_status='definedByValidityTimeSpec' AND valid_from > '2017-01-27T23:45:12+0000');1=1&VERSION=1.1.1&styles=&srs=EPSG:3857&X=235&Y=245

    try {
        var zoom = 8;
        var center = [2226951.83, 6212416.61];
        var rotation = 0;
        var backend_server = 'https://odoprave.global.ssl.fastly.net/';

        /**
         * Define a namespace for the application.
         */
        window.app = {};
        var app = window.app;


        //
        // Define geolocation control.
        //
        /**
         * @constructor
         * @extends {ol.control.Control}
         * @param {Object=} opt_options Control options.
         */
        app.GeoLocationControl = function(opt_options) {

          var options = opt_options || {};

          var button = document.createElement('button');
          button.innerHTML = '<i class="fa fa-dot-circle-o"></i>';
          button.title = options.tipLabel;
          button.id = 'geolocation';

          var element = document.createElement('div');
          element.className = 'geolocation ol-selectable ol-control';
          element.appendChild(button);

          ol.control.Control.call(this, {
            element: element,
            target: options.target
          });

        };
        ol.inherits(app.GeoLocationControl, ol.control.Control);

        function getCookieValue(a) {
            var b = document.cookie.match('(^|;)\\s*' + a + '\\s*=\\s*([^;]+)');
            return b ? b.pop() : '';
        }

        function clearCookies() {
          document.cookie = "map=; expires=-1";
        }

        var tryc = false;
        if (window.location.hash !== '') {
          // try to restore center, zoom-level and rotation from the URL
          var hash = window.location.hash.replace('#map=', '');
          var parts = hash.split('/');
          if (parts.length === 4) {
            zoom = parseInt(parts[0], 10);
            center = [
              parseFloat(parts[1]),
              parseFloat(parts[2])
            ];
            rotation = parseFloat(parts[3]);
          } else {
            tryc = true;
          }
        } else {
          tryc = true;
        }

        // try read default from cookies
        if (tryc == true) {
          var cookie = getCookieValue('map').split('/');
          if (cookie.length === 4) {
            zoom = parseInt(cookie[0], 10);
            center = [
              parseFloat(cookie[1]),
              parseFloat(cookie[2])
            ];
            rotation = parseFloat(cookie[3]);
          }
        }

        var parser = new ol.format.WMTSCapabilities();
        var map;

        fetch(backend_server + '/geoserver/gwc/service/wmts?REQUEST=getcapabilities')
        .then(function(response) {
          return response.text();
        })
        .then(function(text) {
          var result = parser.read(text);
          var options = ol.source.WMTS.optionsFromCapabilities(result,
              {layer: 'nsdi:base_raster', matrixSet: 'EPSG:900913'});
          options.attributions = [new ol.Attribution({
             html: "Mapa &copy; NSDI <a href='https://odoprave.info' target='_blank'>odoprave.info</a>"
          })];

          // REST template, because we want to use CDN caching feature
          options.requestEncoding = 'REST';
          options.urls[0] = backend_server + '/rest/1d/{Layer}/{TileMatrixSet}/GetTile/1.0.0/png/{TileMatrix}/{TileCol}/{TileRow}/map.png';

          var options2 = ol.source.WMTS.optionsFromCapabilities(result,
              {layer: 'nsdi:base_raster_night', matrixSet: 'EPSG:900913'});
          options2.attributions = options.attributions;
          options2.requestEncoding = options.requestEncoding;
          options2.urls[0] = options.urls[0];
          var options3 = ol.source.WMTS.optionsFromCapabilities(result,
              {layer: 'nsdi:ortosr_3857', matrixSet: 'EPSG:900913'});
          options3.attributions = options.attributions;
          options3.requestEncoding = options.requestEncoding;
          options3.urls[0] = backend_server + '/rest/1d/{Layer}/{TileMatrixSet}/GetTile/1.0.0/jpeg/{TileMatrix}/{TileCol}/{TileRow}/map.jpg';

          var attribution = new ol.control.Attribution({
            collapsible: false
          });

          var fspan = document.createElement('i');
          fspan.setAttribute('class', 'fa fa-expand');

          map = new ol.Map({
            layers: [
                new ol.layer.Group({
                    'title': 'Mapy',
                    layers: [
                        new ol.layer.Tile({
                            title: 'Štandarná NSDI',
                            type: 'base',
                            visible: true,
                            source: new ol.source.WMTS(options)
                        }),
                        new ol.layer.Tile({
                            title: 'Nočná NSDI',
                            type: 'base',
                            visible: false,
                            source: new ol.source.WMTS(options2)
                        }),
                        new ol.layer.Tile({
                            title: 'Letecká NSDI',
                            type: 'base',
                            visible: false,
                            source: new ol.source.WMTS(options3)
                        }),
                        new ol.layer.Tile({
                            title: 'OpenStreeMap',
                            type: 'base',
                            visible: false,
                            source: new ol.source.OSM()
                        }),
                    ]
                }),
                new ol.layer.Group({
                    title: 'NSDI vrstvy',
                    layers: [
                        new ol.layer.Tile({
                            title: 'Aktuálna premávka',
                            source: new ol.source.TileWMS({
                                url: backend_server + "/geoserver/nsdi/wms",
                                params: {'LAYERS': 'nsdi:uds'},
                                serverType: 'geoserver'
                            })
                        }),
                        new ol.layer.Tile({
                            title: 'Kolóny',
                            source: new ol.source.TileWMS({
                                url: backend_server + "/geoserver/nsdi/wms",
                                params: {'LAYERS': 'nsdi:traffic_queue'},
                                serverType: 'geoserver'
                            })
                        }),
                        new ol.layer.Tile({
                            title: 'Aktuálne udalosti',
                            source: new ol.source.TileWMS({
                                url: backend_server + "/geoserver/nsdi/wms",
                                params: {'LAYERS': 'nsdi:traffic_event',
                                         CQL_FILTER: "[(traffic_event_status='active') or (traffic_event_status='definedByValidityTimeSpec' AND ((valid_to >= '"+new Date().getFullYear()+"-"+(new Date().getMonth()+1)+"-"+new Date().getDate()+"T"+new Date().getHours()+":"+new Date().getMinutes()+":"+new Date().getSeconds()+"+0000' and valid_from <= '"+new Date().getFullYear()+"-"+(new Date().getMonth()+1)+"-"+new Date().getDate()+"T"+new Date().getHours()+":"+new Date().getMinutes()+":"+new Date().getSeconds()+"+0000') OR (valid_to IS NULL and valid_from <= '"+new Date().getFullYear()+"-"+(new Date().getMonth()+1)+"-"+new Date().getDate()+"T"+new Date().getHours()+":"+new Date().getMinutes()+":"+new Date().getSeconds()+"+0000'))) OR (traffic_event_status='definedByValidityTimeSpec' AND valid_from > '"+new Date().getFullYear()+"-"+(new Date().getMonth()+1)+"-"+new Date().getDate()+"T"+new Date().getHours()+":"+new Date().getMinutes()+":"+new Date().getSeconds()+"+0000')]"
                                },
                                serverType: 'geoserver'
                            }),
                            visible: false
                        }),
                        new ol.layer.Tile({
                            title: 'Plánované udalosti',
                            source: new ol.source.TileWMS({
                                url: backend_server + "/geoserver/nsdi/wms",
                                params: {'LAYERS': 'nsdi:traffic_event',
                                         CQL_FILTER: "[(traffic_event_status='definedByValidityTimeSpec' AND valid_from > '"+new Date().getFullYear()+"-"+(new Date().getMonth()+1)+"-"+new Date().getDate()+"T"+new Date().getHours()+":"+new Date().getMinutes()+":"+new Date().getSeconds()+"+00:00')]"
                                },
                                serverType: 'geoserver'
                            }),
                            visible: false
                        }),
                        new ol.layer.Tile({
                            title: 'Kamery, sčítače',
                            source: new ol.source.TileWMS({
                                url: backend_server + "/geoserver/nsdi/wms",
                                params: {'LAYERS': 'nsdi:v_tech_equipment'},
                                serverType: 'geoserver'
                            }),
                            visible: false
                        }),
                        new ol.layer.Tile({
                            title: 'Cyklocesty',
                            source: new ol.source.TileWMS({
                                url: backend_server + "/geoserver/nsdi/wms",
                                params: {'LAYERS': 'nsdi:cyclo_track'},
                                serverType: 'geoserver'
                            }),
                            visible: false
                        }),
                        new ol.layer.Tile({
                            title: 'Verejná doprava',
                            source: new ol.source.TileWMS({
                                url: backend_server + "/geoserver/nsdi/wms",
                                params: {'LAYERS': 'nsdi:poi_traffic'},
                                serverType: 'geoserver',
                            }),
                            visible: false
                        }),
                        new ol.layer.Tile({
                            title: 'Popisy leteckej mapy',
                            source: new ol.source.TileWMS({
                                url: backend_server + "/geoserver/nsdi/wms",
                                params: {'LAYERS': 'nsdi:label'},
                                serverType: 'geoserver',
                            }),
                            visible: false
                        }),
                    ]
                }),
            ],
            target: 'map',
            view: new ol.View({
              center: center,
              zoom: zoom,
              rotation: rotation,
              minZoom: 8,
              maxZoom: 18,
              //extent: options.projection.f
            }),
            controls: ol.control.defaults({ attribution: false, rotate: false }).extend([
                attribution,
                new ol.control.ScaleLine(),
                new ol.control.FullScreen({ label: fspan, tipLabel: 'Na celú obrazovku' })
              ])
          });

          var shouldUpdate = true;
          var view = map.getView();
          var updatePermalink = function() {
            if (!shouldUpdate) {
              // do not update the URL when the view was changed in the 'popstate' handler
              shouldUpdate = true;
              return;
            }

            var center = view.getCenter();
            var hash = view.getZoom() + '/' +
                Math.round(center[0] * 100) / 100 + '/' +
                Math.round(center[1] * 100) / 100 + '/' +
                view.getRotation();
            var state = {
              zoom: view.getZoom(),
              center: view.getCenter(),
              rotation: view.getRotation()
            };
            window.history.pushState(state, 'map', '#map=' + hash);
            var now = new Date();
            now.setDate(now.getDate() + 30);
            document.cookie = "map=" + hash + "; expires=" + now.toGMTString();
          };

          map.on('moveend', updatePermalink);
          var sidebar = new ol.control.Sidebar({ element: 'sidebar', position: 'left' });
          map.addControl(sidebar);
          var layerSwitcher = new ol.control.LayerSwitcher({
            tipLabel: 'Legenda',
            target: 'switcher'
          });
          map.addControl(layerSwitcher);
          // geolocation control
          var gspan = document.createElement('i');
          gspan.setAttribute('class', 'fa fa-dot-circle-o');
          map.addControl(new app.GeoLocationControl({ target: 'map', label: gspan, tipLabel: 'Lokalizovať' }));
          var geolocation = new ol.Geolocation({
            projection: map.getView().getProjection(),
            trackingOptions: {
              maximumAge: 10000,
              enableHighAccuracy: true,
              timeout: 600000
            }
          });
          document.getElementById('geolocation').addEventListener('click', function() {
            if (geolocation.get("tracking") == true) {
               geolocation.setTracking(false);
            } else {
               geolocation.setTracking(true);
            }
          });
          document.getElementById('geolocation').addEventListener('touchstart', function() {
            if (geolocation.get("tracking") == true) {
               geolocation.setTracking(false);
            } else {
               geolocation.setTracking(true);
            }
          });
          var accuracyFeature = new ol.Feature();
          geolocation.on('change:accuracyGeometry', function() {
            accuracyFeature.setGeometry(geolocation.getAccuracyGeometry());
          });

         // handle geolocation error.
         geolocation.on('error', function(error) {
           // todo
           alert("Geolocation problem: " + error.message);
           ga('send', 'exception', {
             'exDescription': "Geolocation problem: " + error.message,
             'exFatal': false
           });
         });

          var positionFeature = new ol.Feature();
          positionFeature.setStyle(new ol.style.Style({
            image: new ol.style.Circle({
              radius: 6,
              fill: new ol.style.Fill({
                color: '#3399CC'
              }),
              stroke: new ol.style.Stroke({
                color: '#fff',
                width: 2
              })
            })
          }));

          geolocation.on('change:position', function() {
            var coordinates = geolocation.getPosition();
            map.getView().setCenter(coordinates);
            positionFeature.setGeometry(coordinates ?
                new ol.geom.Point(coordinates) : null);
          });

          new ol.layer.Vector({
            map: map,
            source: new ol.source.Vector({
              features: [accuracyFeature, positionFeature]
            })
          });

          // restore the view state when navigating through the history, see
          // https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onpopstate
          window.addEventListener('popstate', function(event) {
            if (event.state === null) {
              return;
            }
            map.getView().setCenter(event.state.center);
            map.getView().setZoom(event.state.zoom);
            map.getView().setRotation(event.state.rotation);
            shouldUpdate = false;
          });
        })
        .catch(function(error) {
          console.log('There has been a problem with fetch operation: ' + error.message);
        });
    } catch(err) {
      ga('send', 'exception', {
        'exDescription': err.message,
        'exFatal': false
      });
    }
    </script>
</body>
</html>
